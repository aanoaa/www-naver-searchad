#!/usr/bin/env perl
use strict;
use warnings;

use SearchAd::Schema;
use WWW::Naver::SearchAd::Rank 'find_rank';

STDOUT->autoflush(1);

my $schema = SearchAd::Schema->connect(
    {
        dsn            => "dbi:SQLite:db/searchad.db",
        quote_char     => q{`},
        sqlite_unicode => 1,
    }
);

while (1) {
    my $rs = $schema->resultset('Rank')->search( { on_off => 1 } );
    while ( my $rank = $rs->next ) {
        my $adkeyword = $rank->adkeywords->next;
        my $adgroup   = $adkeyword->adgroup;
        my $url       = $adgroup->target->url;
        $url =~ s{^https?://}{};
        my $r = find_rank( $adkeyword->name, $url );
        $rank->update( { rank => $r } ) if $r;
    }

    sleep(60);
}

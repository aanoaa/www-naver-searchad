#!/usr/bin/env perl
use strict;
use warnings;

use Directory::Queue;
use SearchAd::Schema;
use WWW::Naver::SearchAd::Rank 'find_rank';

STDOUT->autoflush(1);

my $schema = SearchAd::Schema->connect(
    {
        dsn            => "dbi:SQLite:db/searchad.db",
        quote_char     => q{`},
        sqlite_unicode => 1,
    }
);

my $dirq = Directory::Queue->new( path => '/tmp/searchad' );

while (1) {
    my $rs = $schema->resultset('Rank')->search( { on_off => 1 } );
    while ( my $r = $rs->next ) {
        my $adkeyword = $r->adkeywords->next;
        my $adgroup   = $adkeyword->adgroup;
        my $url       = $adgroup->target->url;
        $url =~ s{^https?://}{};
        my $rank = find_rank( $adkeyword->name, $url ) || 0;
        $r->update( { rank => $rank } );
    }

    sleep(60);
}
